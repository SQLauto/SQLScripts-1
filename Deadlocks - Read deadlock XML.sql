declare @deadlock xml
set @deadlock = '<deadlock-list>   <deadlock victim="process38365c8">    <process-list>     <process id="process38365c8" taskpriority="0" logused="640" waitresource="PAGE: 5:1:8613381" waittime="1372" ownerId="331163361" transactionname="user_transaction" lasttranstarted="2012-04-17T14:57:01.067" XDES="0x800754b0" lockMode="S" schedulerid="6" kpid="5700" status="suspended" spid="62" sbid="0" ecid="0" priority="0" transcount="1" lastbatchstarted="2012-04-17T14:57:01.587" lastbatchcompleted="2012-04-17T14:57:01.587" clientapp="BID Version 4.0" hostname="CSAN0AS70" hostpid="3524" loginname="CoxTracking" isolationlevel="read committed (2)" xactid="331163361" currentdb="5" lockTimeout="4294967295" clientoption1="673185824" clientoption2="128056">      <executionStack>       <frame procname="BID2007.dbo.up_GetWorkFlowLogTreeInOrderAsRows" line="81" stmtstart="6062" stmtend="9380" sqlhandle="0x03000500029a4c67773cfe00069e00000100000000000000">  Insert Into @workFlowLog    Select Distinct     WFL.WORKFLOWLOGID, WFL.SYSTEMID, WFL.WORKFLOWTYPEID, WFL.WORKFLOWSTEPID,      WFL.WORKFLOWEVENTID, WFL.EVENTNAME, WFL.EVENTDESCRIPTION, WFL.PARENTID, WFL.KEY1ID,      WFL.KEY2ID, WFL.SYSTEMMODULEGROUPID, WFL.SYSTEMMODULEGROUPNAME, WFL.ASSIGNEDTOUSERID,     WFL.ASSIGNEDTOUSERNAME, WFL.COMPLETEDBYUSERID, WFL.COMPLETEDBYUSERNAME,     WFL.STEPNUMBER, WFL.DAYSTOCOMPLETE, WFL.TARGETCOMPLETEDDATE,     WFL.PROJECTEDCOMPLETEDDATE, WFL.COMPLETEDDATE, WFL.SENTBACKID,WFL.MANAGEDDELIVERYDATE,      WFL.ANSWEREDYESFLAG, WFL.ARCHIVEFLAG,     WFL.INSERTEDDATE, Count(WFL_SUB.WORKFLOWLOGID), @stepNumberText1 + Cast(WFL.STEPNUMBER As VarChar)    From     WORKFLOWLOG WFL, WORKFLOWLOG WFL_SUB    Where 1 = 1     And WFL.WORKFLOWLOGID *= WFL_SUB.PARENTID     And WFL.WORKFLOWTYPEID = @workFlowTypeID1     And WFL.KEY1ID = @key1ID1     And IsNull(WFL.KEY2ID,0) = IsNull(@key2ID1,0)     And ( (WFL.PARENTID Is Null and @MCD = 0)      or (@MCD = 1 And WFL.PARENTID = @MCDID AND WFL.PARENTID IS     </frame>       <frame procname="BID2007.dbo.up_UpdateWorkFlowLogNumbersAndDatesForCompleteWorkFlowAction" line="66" stmtstart="5980" stmtend="6218" sqlhandle="0x03000500c560d503b7d6e9001d9c00000100000000000000">  Insert Into #CURRENT_WORKFLOWLOG   Exec up_GetWorkFlowLogTreeInOrderAsRows @workFlowTypeID, @key1ID, @key2ID, 0     </frame>       <frame procname="BID2007.dbo.up_CompleteWorkFlowLog" line="257" stmtstart="19492" stmtend="19836" sqlhandle="0x030005008e71ec452cf1ee00849d00000100000000000000">  Exec up_UpdateWorkFlowLogNumbersAndDatesForCompleteWorkFlowAction @workFlowTypeID, @key1ID, @key2ID, @updatedByUserID, @updatedDate, @updateTargetDateFlag,@workFlowLogID     </frame>      </executionStack>      <inputbuf>  Proc [Database Id = 5 Object Id = 1173123470]    </inputbuf>     </process>     <process id="process99db828" taskpriority="0" logused="14936" waitresource="PAGE: 5:1:8618120" waittime="1138" ownerId="331157079" transactionname="user_transaction" lasttranstarted="2012-04-17T14:56:59.553" XDES="0x1fa82a700" lockMode="S" schedulerid="11" kpid="11392" status="suspended" spid="77" sbid="0" ecid="0" priority="0" transcount="2" lastbatchstarted="2012-04-17T14:57:00.060" lastbatchcompleted="2012-04-17T14:57:00.060" clientapp="BID Version 4.0" hostname="CSAN0AS70" hostpid="3524" loginname="CoxTracking" isolationlevel="read committed (2)" xactid="331157079" currentdb="5" lockTimeout="4294967295" clientoption1="673185824" clientoption2="128056">      <executionStack>       <frame procname="BID2007.dbo.up_ApproveService" line="616" stmtstart="56770" stmtend="57954" sqlhandle="0x03000500928941688040f100b39d00000100000000000000">  Insert into #WorkFlowLog    (     workFlowEventID,workFlowStepID,systemModuleGroupID,     systemModuleGroupName,assignedToUserID,assignedToUserName,StepNumber    )    Select workFlowEventID, workFlowStepID,systemModuleGroupID,      systemModuleGroupName,assignedToUserID,assignedToUserName,StepNumber    From WorkFlowLog    Where 1=1    And  key1ID in      (        Select Service.ServiceID       From Service,ServiceApproval       Where 1=1       And  [Service].ServiceID = [ServiceApproval].ServiceID       And  OrderID = @OrderID        And  ApprovalTypeID = 1               )     </frame>      </executionStack>      <inputbuf>  Proc [Database Id = 5 Object Id = 1749125522]    </inputbuf>     </process>    </process-list>    <resource-list>     <pagelock fileid="1" pageid="8613381" dbid="5" objectname="BID2007.dbo.WorkFlowLog" id="lock26c500300" mode="IX" associatedObjectId="72057607037911040">      <owner-list>       <owner id="process99db828" mode="IX"/>      </owner-list>      <waiter-list>       <waiter id="process38365c8" mode="S" requestType="wait"/>      </waiter-list>     </pagelock>     <pagelock fileid="1" pageid="8618120" dbid="5" objectname="BID2007.dbo.WorkFlowLog" id="lock41e2b0a80" mode="IX" associatedObjectId="72057607037845504">      <owner-list>       <owner id="process38365c8" mode="IX"/>      </owner-list>      <waiter-list>       <waiter id="process99db828" mode="S" requestType="wait"/>      </waiter-list>     </pagelock>    </resource-list>   </deadlock>  </deadlock-list>  '

select 
	 [Victim] = case when Deadlock.Process.value('@id', 'varchar(50)') = @deadlock.value('/deadlock-list[1]/deadlock[1]/@victim', 'varchar(50)') then 1 else 0 end
	 ,[Procedure] = Deadlock.Process.value('executionStack[1]/frame[1]/@procname[1]', 'varchar(200)')
	 ,[LockMode] = Deadlock.Process.value('@lockMode', 'char(1)')
	 ,[Code] = Deadlock.Process.value('executionStack[1]/frame[1]', 'varchar(1000)')
	 ,[ClientApp] = Deadlock.Process.value('@clientapp', 'varchar(100)')
	 ,[HostName] = Deadlock.Process.value('@hostname', 'varchar(20)')
	 ,[LoginName] = Deadlock.Process.value('@loginname', 'varchar(20)')
	 ,[TransactionTime] = Deadlock.Process.value('@lasttranstarted', 'datetime')
	 ,[InputBuffer] = Deadlock.Process.value('inputbuf[1]', 'varchar(1000)')
	 ,[Partition_ID] = @deadlock.value('deadlock-list[1]/deadlock[1]/resource-list[1]/keylock[1]/@hobtid', 'varchar(200)')
	 
	 ,[PagelockObject] = @deadlock.value('/deadlock-list[1]/deadlock[1]/resource-list[1]/pagelock[1]/@objectname', 'varchar(200)')
	 ,[DeadlockObject] = @deadlock.value('/deadlock-list[1]/deadlock[1]/resource-list[1]/objectlock[1]/@objectname', 'varchar(200)')
	 ,[KeylockObject] = @deadlock.value('/deadlock-list[1]/deadlock[1]/resource-list[1]/keylock[1]/@objectname', 'varchar(200)')
	 
	 ,[PageLock CurrentLock] = @deadlock.value('deadlock-list[1]/deadlock[1]/resource-list[1]/pagelock[1]/owner-list[1]/owner[1]/@mode', 'varchar(200)')
	 ,[PageLock RequestedLock] = @deadlock.value('deadlock-list[1]/deadlock[1]/resource-list[1]/pagelock[1]/waiter-list[1]/waiter[1]/@mode', 'varchar(200)')
	 
	 ,[KeyLock CurrentLock] = @deadlock.value('deadlock-list[1]/deadlock[1]/resource-list[1]/keylock[1]/owner-list[1]/owner[1]/@mode', 'varchar(200)')
	 ,[KeyLock RequestedLock] = @deadlock.value('deadlock-list[1]/deadlock[1]/resource-list[1]/keylock[1]/waiter-list[1]/waiter[1]/@mode', 'varchar(200)')
 from @deadlock.nodes('/deadlock-list/deadlock/process-list/process') as Deadlock(Process)
	
